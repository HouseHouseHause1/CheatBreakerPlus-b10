/*
 * Decompiled with CFR 0.151.
 * 
 * Could not load the following classes:
 *  net.minecraft.block.Block
 *  net.minecraft.block.state.IBlockState
 *  net.minecraft.entity.Entity
 *  net.minecraft.entity.item.EntityEnderCrystal
 *  net.minecraft.init.Blocks
 *  net.minecraft.network.Packet
 *  net.minecraft.network.play.client.CPacketAnimation
 *  net.minecraft.network.play.client.CPacketPlayerDigging
 *  net.minecraft.network.play.client.CPacketPlayerDigging$Action
 *  net.minecraft.util.EnumFacing
 *  net.minecraft.util.EnumHand
 *  net.minecraft.util.math.AxisAlignedBB
 *  net.minecraft.util.math.BlockPos
 *  net.minecraft.world.World
 */
package me.travis.wurstplus.wurstplustwo.hacks.exploit;

import java.util.function.Predicate;
import me.travis.wurstplus.wurstplustwo.event.events.WurstplusEventBlock;
import me.travis.wurstplus.wurstplustwo.event.events.WurstplusEventPacket;
import me.travis.wurstplus.wurstplustwo.guiscreen.settings.WurstplusSetting;
import me.travis.wurstplus.wurstplustwo.hacks.WurstplusCategory;
import me.travis.wurstplus.wurstplustwo.hacks.WurstplusHack;
import me.travis.wurstplus.wurstplustwo.util.WurstplusTimer;
import me.zero.alpine.fork.listener.EventHandler;
import me.zero.alpine.fork.listener.Listener;
import net.minecraft.block.Block;
import net.minecraft.block.state.IBlockState;
import net.minecraft.entity.Entity;
import net.minecraft.entity.item.EntityEnderCrystal;
import net.minecraft.init.Blocks;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketAnimation;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.util.math.BlockPos;
import net.minecraft.world.World;

public class WurstplusSpeedmine
extends WurstplusHack {
    WurstplusSetting mode = this.create("Mode", "SpeedmineMode", "Normal", this.combobox("Normal", "Packet", "Damage", "Instant"));
    WurstplusSetting damage = this.create("Damage Ammount", "SpeedmineDamagaeAmmount", 0.7, 0.0, 1.0);
    WurstplusSetting reset = this.create("Reset", "SpeedmineReset", true);
    WurstplusSetting no_break_anim = this.create("No Break Anim", "SpeedMineBreakAnim", false);
    WurstplusSetting no_delay = this.create("No Delay", "SpeedmineNoDelay", false);
    WurstplusSetting no_swing = this.create("No Swing", "SpeedmineNoSwing", false);
    WurstplusSetting allow = this.create("MultiTask", "SpeedmineMultiTask", false);
    WurstplusSetting double_break = this.create("Double Break", "SpeedmineDoubleBreak", false);
    private final WurstplusTimer timer = new WurstplusTimer();
    private IBlockState current_block_state = null;
    private BlockPos current_pos = null;
    private BlockPos last_pos = null;
    private EnumFacing last_facing = null;
    private boolean is_mining = false;
    @EventHandler
    private Listener<WurstplusEventPacket.SendPacket> send_listener = new Listener<WurstplusEventPacket.SendPacket>(event -> {
        if (this.no_swing.get_value(true) && event.get_packet() instanceof CPacketAnimation) {
            event.cancel();
        }
        if (this.no_break_anim.get_value(true) && event.get_packet() instanceof CPacketPlayerDigging) {
            CPacketPlayerDigging p = (CPacketPlayerDigging)event.get_packet();
            try {
                for (Entity entity : WurstplusSpeedmine.mc.world.getEntitiesWithinAABBExcludingEntity(null, new AxisAlignedBB(p.getPosition()))) {
                    if (!(entity instanceof EntityEnderCrystal)) continue;
                    this.show_anim();
                    return;
                }
            }
            catch (Exception exception) {
                // empty catch block
            }
            if (p.getAction().equals((Object)CPacketPlayerDigging.Action.START_DESTROY_BLOCK)) {
                this.show_anim(true, p.getPosition(), p.getFacing());
            }
            if (p.getAction().equals((Object)CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK)) {
                this.show_anim();
            }
        }
    }, new Predicate[0]);
    @EventHandler
    private Listener<WurstplusEventBlock> block_event = new Listener<WurstplusEventBlock>(event -> {
        if (event.get_stage() == 3 && this.reset.get_value(true) && WurstplusSpeedmine.mc.playerController.curBlockDamageMP > 0.1f) {
            WurstplusSpeedmine.mc.playerController.isHittingBlock = true;
        }
        if (event.get_stage() == 4 && !this.mode.in("Normal")) {
            BlockPos above;
            if (WurstplusSpeedmine.canBreak(event.pos)) {
                if (this.reset.get_value(true)) {
                    WurstplusSpeedmine.mc.playerController.isHittingBlock = false;
                }
                if (this.mode.in("Packet")) {
                    if (this.current_pos == null) {
                        this.current_pos = event.pos;
                        this.current_block_state = WurstplusSpeedmine.mc.world.getBlockState(this.current_pos);
                        this.timer.reset();
                    }
                    WurstplusSpeedmine.mc.player.swingArm(EnumHand.MAIN_HAND);
                    WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, event.pos, event.facing));
                    WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
                    event.cancel();
                }
                if (this.mode.in("Damage") && WurstplusSpeedmine.mc.playerController.curBlockDamageMP >= (float)this.damage.get_value(1)) {
                    WurstplusSpeedmine.mc.playerController.curBlockDamageMP = 1.0f;
                }
                if (this.mode.in("Instant")) {
                    WurstplusSpeedmine.mc.player.swingArm(EnumHand.MAIN_HAND);
                    WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, event.pos, event.facing));
                    WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, event.pos, event.facing));
                    WurstplusSpeedmine.mc.playerController.onPlayerDestroyBlock(event.pos);
                    WurstplusSpeedmine.mc.world.setBlockToAir(event.pos);
                }
            }
            if (this.double_break.get_value(true) && WurstplusSpeedmine.canBreak(above = event.pos.up()) && WurstplusSpeedmine.mc.player.getDistance((double)above.getX(), (double)above.getY(), (double)above.getZ()) <= 5.0) {
                WurstplusSpeedmine.mc.player.swingArm(EnumHand.MAIN_HAND);
                WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, above, event.facing));
                WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, above, event.facing));
                WurstplusSpeedmine.mc.playerController.onPlayerDestroyBlock(above);
                WurstplusSpeedmine.mc.world.setBlockToAir(above);
            }
        }
    }, new Predicate[0]);

    public WurstplusSpeedmine() {
        super(WurstplusCategory.WURSTPLUS_EXPLOIT);
        this.name = "Speed Mine";
        this.tag = "SpeedMine";
        this.description = "mine faster";
    }

    @Override
    public void update() {
        if (!(this.current_pos == null || WurstplusSpeedmine.mc.world.getBlockState(this.current_pos).equals(this.current_block_state) && WurstplusSpeedmine.mc.world.getBlockState(this.current_pos).getBlock() != Blocks.AIR)) {
            this.current_pos = null;
            this.current_block_state = null;
        }
        if (this.no_delay.get_value(true)) {
            WurstplusSpeedmine.mc.playerController.blockHitDelay = 0;
        }
        if (this.is_mining && this.last_pos != null && this.last_facing != null && this.no_break_anim.get_value(true)) {
            WurstplusSpeedmine.mc.player.connection.sendPacket((Packet)new CPacketPlayerDigging(CPacketPlayerDigging.Action.ABORT_DESTROY_BLOCK, this.last_pos, this.last_facing));
        }
        if (this.reset.get_value(true) && WurstplusSpeedmine.mc.gameSettings.keyBindUseItem.isKeyDown() && !this.allow.get_value(true)) {
            WurstplusSpeedmine.mc.playerController.isHittingBlock = false;
        }
    }

    public void show_anim(boolean is_mining, BlockPos last_pos, EnumFacing last_facing) {
        this.is_mining = is_mining;
        this.last_pos = last_pos;
        this.last_facing = last_facing;
    }

    public void show_anim() {
        this.show_anim(false, null, null);
    }

    @Override
    public String array_detail() {
        return this.mode.get_current_value();
    }

    public static boolean canBreak(BlockPos pos) {
        IBlockState blockState = WurstplusSpeedmine.mc.world.getBlockState(pos);
        Block block = blockState.getBlock();
        return block.getBlockHardness(blockState, (World)WurstplusSpeedmine.mc.world, pos) != -1.0f;
    }
}

